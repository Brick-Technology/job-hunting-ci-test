name: build
run-name: ${{ github.actor }} 构建插件
on:
  push:
    branches:
      - dev
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build-extension:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install
        
      - name: Package
        run: |
          pnpm install
          pnpm run build
          pnpm run build:firefox

      - name: Deploy chrome dist branch
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: dist/chrome-${{  github.ref_name }}
          folder: .output/chrome-mv3

      - name: Deploy firefox dist branch
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: dist/firefox-${{  github.ref_name }}
          folder: .output/firefox-mv2
      
      - name: Gen latest changelog
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          awk '/^##[^#]/{print NR}' CHANGELOG.md | head -n 2 | xargs | tr ' ' ',' | xargs -I {} sed -n {}p  CHANGELOG.md | sed '$d' > ${{ github.workspace }}-CHANGELOG.txt

      - name: Rename dist
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mv .output/chrome-mv3 job-hunting-extension-chrome-${{  github.ref_name }}
          mv .output/firefox-mv2 job-hunting-extension-firefox-${{  github.ref_name }}

      - name: Zip chrome dist
        uses: montudor/action-zip@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          args: zip -qq -r job-hunting-extension-chrome-${{  github.ref_name }}.zip job-hunting-extension-chrome-${{  github.ref_name }}

      - name: Zip firefox dist
        uses: montudor/action-zip@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          args: zip -qq -r job-hunting-extension-firefox-${{  github.ref_name }}.zip job-hunting-extension-firefox-${{  github.ref_name }}

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          files: |
            job-hunting-extension-chrome-${{  github.ref_name }}.zip
            job-hunting-extension-firefox-${{  github.ref_name }}.zip
